<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />
        <title>Interface</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
            integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
            crossorigin="anonymous"
        />
        <script
            src="https://code.jquery.com/jquery-3.6.4.min.js"
            integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8="
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
            integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <div class="container" data-bs-theme="dark">
            <div class="row">
                <div class="col-sm-12 col-md-8">
                    <h1>LED-Matrix Game</h1>
                </div>
                <div class="col-sm-12 col-md-4">
                    <span class="m-auto" id="game-status"></span>
                </div>
            </div>

            <div class="row">
                <select
                    class="form-select"
                    id="animations"
                    aria-label="Animations"
                ></select>
            </div>
        </div>
        <script>
            $(document).ready(function () {
                let connection = new WebSocket("ws://192.168.25.166:81");

                connection.onopen = function () {
                    console.log("Verbindung geÃ¶ffnet");
                    keepAlive();

                    connection.send(
                        JSON.stringify({
                            event: "animations",
                            data: {},
                        })
                    );
                };

                // Log errors
                connection.onerror = function (error) {
                    console.log("WebSocket Error " + error);
                };

                // Log messages from the server
                connection.onmessage = function (e) {
                    console.log("Server: " + e.data);

                    try {
                        const response = JSON.parse(e.data);

                        switch (response["event"]) {
                            case "animations":
                                setAnimations(response["data"]);
                                break;
                        }
                    } catch (e) {}
                };

                let timerId = 0;

                const keepAlive = (timeout = 5000) => {
                    if (connection.readyState == connection.OPEN) {
                        connection.send(
                            JSON.stringify({ event: "ping", data: true })
                        );
                    }
                    timerId = setTimeout(keepAlive, timeout);
                };

                const cancelKeepAlive = () => {
                    if (timerId) {
                        clearTimeout(timerId);
                    }
                };

                const setAnimations = (animations) => {
                    const elm = $("#animations");
                    elm.html("");
                    elm.append(new Option("", ""));
                    animations.forEach((anim) =>
                        elm.append(new Option(anim, anim))
                    );
                };

                $("#animations").on("change", () => {
                    connection.send(
                        JSON.stringify({
                            event: "animation",
                            data: {
                                name: $("#animations option:selected").val(),
                            },
                        })
                    );
                });
            });
        </script>
    </body>
</html>
